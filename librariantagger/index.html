<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>ShelvAR Tag Generator</title>

<script src="jquery-1.6.4.min.js" type="text/javascript"></script>

<script type="text/javascript">

	var timers = new Array();
	timers['LCnum'] = 0;
	var fields = new Array();

	/**
	 * Function stub, reduces length of element references.
	 */
	var doc = function(ele) { return document.getElementById(ele); }
	
	/**
	 * function SetTimer()
	 * Called when text changes in the input box.
	 * Resets any information regarding success/failure
	 * and sets/resets timeout before sending ajax request.
	 */
	function SetTimer(id)
	{	
		if(timers[id] != 0) { clearTimeout(timers[id]); }

		doc(id).style.color = "#000";	
		doc(id + '_error').innerHTML = '';
		doc(id + '_tag').innerHTML = '';
			
		timers[id] = setTimeout("CheckNum('" + id + "')", 1000);
	}
	
	/**
	 * function CheckNum()
	 * When input timer expires, this function is called
	 * to initiate the ajax request and handle the response
	 * for the text field where a single LC num is entered.
	 */
	function CheckNum(id)
	{	
		id = doc(id);
		
		var lcjson = '{ "lcNum" : "' + id.value + '" }';
		
		$.post("../lcparse/parse.php", 
			{ callNumInput: lcjson }, 
			function(ret) {
				CheckNumResponse(ret, id);
			}, "json");
	}
	
	function CheckNumResponse(ret, id)
	{	
		if(ret.allow) {
			id.style.color = "#0F0";
			doc(id.id + '_tag').innerHTML = DisplayImage(ret.lcNum);
		} else {
			id.style.color = "#F00"; 
		}
		
		if(!ret.warningFree) {
			doc(id.id + '_error').innerHTML = DisplayWarnings(ret.arrOfConflicts);
		}
	}
	
	/**
	 * function CheckNums()
	 * When input timer expires, this function is called
	 * to initiate the ajax request and handle the response
	 * for the textarea where multiple LC nums are entered.
	 */
	function CheckNums()
	{
		var nums = doc('LCnums').value;
		nums = nums.split('\n');
		
		$.post("../lcparse/parseMultiple.php", 
			{ callNumInput: JSON.stringify(nums) },
			function(ret) {
				CheckNumsResponse(ret, nums);
			}, "json");
	}
	
	function CheckNumsResponse(ret, nums)
	{
		doc('multi').innerHTML = "";
		
		var i;
		for(i = 0; i < ret.length; i++)
		{
			ret[i].original = nums[i];
			GenerateLCField(ret[i], i);
		}
	}
	
	function GenerateLCField(ret, id)
	{
		id = "num" + id;
	
		var div = document.createElement('div');
		div.style.cssFloat = 'left';
		div.style.width = '162px';
		
		var input = document.createElement('input');
		input.setAttribute('type', 'text');
		input.setAttribute('value', ret.original);
		input.setAttribute('id', id);
		input.setAttribute('onkeyup', 'SetTimer("' + id + '")');
		
		var errors = document.createElement('p');
		errors.setAttribute('id', id + '_error');
		var tag = document.createElement('p');
		tag.setAttribute('id', id + '_tag');
		
		if(!ret.warningFree){
			errors.innerHTML += DisplayWarnings(ret.arrOfConflicts);
		}
		
		if(ret.allow) { 
			input.style.color = '#0F0';
			tag.innerHTML += DisplayImage(ret.lcNum); 
		} else { 
			input.style.color = '#F00'; 
		}
		
		div.appendChild(input);
		div.appendChild(document.createElement('br'));
		div.appendChild(errors);
		div.appendChild(tag);
		
		doc('multi').appendChild(div);
	}
	
	/**
	 * function DisplayImage(data)
	 * Stub that will eventually fetch a generated
	 * image tag based on parsed LC data.
	 * @param data The parsed LC number returned
	 * from the ajax request to the parser.
	 */
	function DisplayImage(num)
	{	
		var tag;
	
		$.post("../lc2bin/LC2B64.php", 
			{ "LC": JSON.stringify(num) }, 
			function(ret) {
				tag = ret.base64;
			}, "json");
		
		return '<img src=\"../tagmaker/' + tag + '.png\" />';
	}
	
	function DisplayWarnings(warn)
	{
		var i;
		var html = "";
		
		for(i = 0; i < warn.length; i++)
		{
			if(warn[i].isWarning) {
				html += "<span style=\"color:#ffd700;\">" + warn[i].msg + "</span><br /><br />"
			} else {
				html += "<span style=\"color:#F00;\">" + warn[i].msg + "</span><br /><br />"
			}
		}
		
		return html;
	}

</script>

</head>

	<body>

		Enter an LC call number:<br />
        <input type="text" id="LCnum" onkeyup="SetTimer('LCnum');" />
        <div id="LCnum_error" style="color:red; font-weight:bold;"></div>
        <div id="LCnum_tag"></div>
        
        <br />
        
        Enter LC call numbers, one per line:<br />
        <div id="multi">
        <textarea name="" cols="" rows="" wrap="off" id="LCnums"></textarea><br />
        <button onclick="CheckNums();">Check Nums</button>
        </div>
        
        <div id="moderator-embed-target" style="clear:both;"><br /><a href="" onclick="MODERATOR_embed('http://www.google.com/moderator/#16/e=bd23d', 'moderator-embed-target'); return false;">make a suggestion</a></div>
        <script type="text/javascript">
            
        </script>

	</body>
    
</html>
