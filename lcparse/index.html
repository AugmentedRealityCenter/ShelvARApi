<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>ShelvAR Tag Generator</title>

<script src="librariantagger/jquery-1.6.4.min.js" type="text/javascript"></script>

<script type="text/javascript">

	var nums;
	var timer = 0;
	var fields = new Array();

	/**
	 * Function stub, reduces length of element references.
	 */
	var doc = function(ele) { return document.getElementById(ele); }
	
	/**
	 * function SetTimer()
	 * Called when text changes in the input box.
	 * Resets any information regarding success/failure
	 * and sets/resets timeout before sending ajax request.
	 */
	function SetTimer()
	{
		if(timer) { clearTimeout(timer); }

		doc('LCnum').style.color = "#000";	
		doc('error').innerHTML = '';
		doc('tag').innerHTML = '';
			
		timer = setTimeout(CheckNum, 1000);
	}
	
	/**
	 * function CheckNum()
	 * When input timer expires, this function is called
	 * to initiate the ajax request and handle the response
	 * for the text field where a single LC num is entered.
	 */
	function CheckNum()
	{
		var lcjson = '{ "lcNum" : "' + doc('LCnum').value + '" }';
		
		alert('initiating call');
		
		$.post("../lcparse/parse.php", 
			{ callNumInput: lcjson }, 
			CheckNumResponse, 
			"json");
	}
	
	function CheckNumResponse(ret)
	{
		alert('response received');
		
		if(ret.allow) {
			doc('LCnum').style.color = "#0F0";
			doc('tag').innerHTML = DisplayImage(ret.lcNum);
		} else {
			doc('LCnum').style.color = "#F00"; 
		}
		
		if(!ret.warningFree) {
			doc('error').innerHTML = DisplayWarnings(ret.arrOfConflicts);
		}
	}
	
	/**
	 * function CheckNums()
	 * When input timer expires, this function is called
	 * to initiate the ajax request and handle the response
	 * for the textarea where multiple LC nums are entered.
	 */
	function CheckNums()
	{
		nums = doc('LCnums').value;
		nums = nums.split('\n');
		
		$.post("../lcparse/parseMultiple.php", 
			{ callNumInput: JSON.stringify(nums) },
			CheckNumsResponse, 
			"json");
	}
	
	function CheckNumsResponse(ret)
	{
		doc('multi').innerHTML = "";
		
		var i;
		for(i = 0; i < ret.length; i++)
		{
			ret[i].original = nums[i];
			GenerateLCField(ret[i]);
		}
	}
	
	function GenerateLCField(ret)
	{
		alert('creating div');
		var div = document.createElement('div');
		div.style.cssFloat = 'left';
		
		alert('creating input');
		var input = document.createElement('input');
		input.setAttribute('type', 'text');
		input.setAttribute('value', ret.original);
		
		alert('creating p for warnings/image');
		var p = document.createElement('p');
		
		if(!ret.warningFree){
			alert('adding warnings to p');
			p.innerHTML += DisplayWarnings(ret.arrOfConflicts);
		}
		
		if(ret.allow) { 
			alert('setting color, adding image');
			input.style.color = '#0F0';
			p.innerHTML += DisplayImage(ret.lcNum); 
		} else { 
			input.style.color = '#F00'; 
		}
		
		alert('appending children');
		div.appendChild(input);
		div.appendChild(document.createElement('br'));
		div.appendChild(p);
		
		doc('multi').appendChild(div);
	}
	
	/**
	 * function DisplayImage(data)
	 * Stub that will eventually fetch a generated
	 * image tag based on parsed LC data.
	 * @param data The parsed LC number returned
	 * from the ajax request to the parser.
	 */
	function DisplayImage(num)
	{
		// STUB: use url based tag generator
		
		return '<img src=\"original.png\" />';
	}
	
	function DisplayWarnings(warn)
	{
		var i;
		var html = "";
		
		for(i = 0; i < warn.length; i++)
		{
			if(warn[i].isWarning) {
				html += "<span style=\"color:#ffd700;\">" + warn[i].msg + "</span><br />"
			} else {
				html += "<span style=\"color:#F00;\">" + warn[i].msg + "</span><br />"
			}
		}
		
		return html;
	}
	
	function AssembleLCNum(lcnum)
	{

	}

</script>

</head>

	<body>

		Enter an LC call number:<br />
        <input type="text" id="LCnum" onkeypress="SetTimer();" />
        <div id="error" style="color:red; font-weight:bold;"></div>
        <div id="tag"></div>
        
        <br />
        
        Enter LC call numbers, one per line:<br />
        <div id="multi">
        <textarea name="" cols="" rows="" wrap="off" id="LCnums"></textarea><br />
        <button onclick="CheckNums();">Check Nums</button>
        </div>
        
        <div id="moderator-embed-target" style="clear:both;"><br /><a href="" onclick="MODERATOR_embed('http://www.google.com/moderator/#16/e=bd23d', 'moderator-embed-target'); return false;">make a suggestion</a></div>
        <script type="text/javascript">
            
        </script>

	</body>
    
</html>
