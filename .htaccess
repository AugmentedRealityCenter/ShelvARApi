#This htaccess file implements site-based
# licensing for ShelvAR. Each supported site needs
# a rule that sets their institution code.
RewriteEngine On
Access-Control-Allow-Origin *

#If the user is access the doc directory, do nothing
RewriteRule ^doc - [L]

#First, delete any institution the user put in
RewriteCond %{QUERY_STRING} ^(([^&]*&)*)institution=[^&]*((&[^&]*)*)$
RewriteRule (.*) $1?%1%3

#Miami University of Ohio
RewriteCond %{REMOTE_ADDR} ^134\.53\.(.*)\.(.*)$ [OR]
RewriteCond %{REMOTE_ADDR} ^172\.25\.5.\.(.*)$ [OR]
RewriteCond %{REMOTE_ADDR} ^172\.25\.120.\.(.*)$ [OR]
RewriteCond %{REMOTE_ADDR} ^172\.25\.27\.144$ [OR]
RewriteCond %{REMOTE_ADDR} ^10\.(.*).\.(.*)\.(.*)$
RewriteRule (.*) $1?institution=muohio [QSA]

#TEST - Brinkman's house
RewriteCond %{REMOTE_ADDR} ^74\.83\.118\.5.$ [OR]
RewriteCond %{REMOTE_ADDR} ^74\.215\.173\.188$ [OR]
RewriteCond %{REMOTE_ADDR} ^74\.83\.66\.91$
RewriteRule (.*) $1?institution=brinkman [QSA]

#Eliot's Pad
RewriteCond %{REMOTE_ADDR} ^24\.164\.78\.127$
RewriteRule (.*) $1?institution=eliot [QSA]

#If no institution, redirect to sorry page
RewriteCond %{QUERY_STRING} !institution
RewriteRule (.*) sorry.php [L]

###########
### API ###
###########

# ^api/B642LC/ = does the page start with "api/B642LC"
# ([^/.]+) = capture 1+ characters that aren't '.' or '/' and store them in $1
# /?$ = only allows a POSSIBLE '/'
# Therefore: accessing ".../api/B642LC/blah" will actually call ".../api/book_tags/B642LC.php?B64=blah"
RewriteCond %{THE_REQUEST} GET
RewriteRule ^api/book_tags/([^/]+)(?=.json) api/lc2bin/B642LC.php?B64=$1 [L,QSA]

# Same as above for LC2B64
RewriteCond %{THE_REQUEST} GET
RewriteRule ^api/call_numbers/([^/]+)(?=.json) api/lc2bin/call_numbers.php?call_number=$1 [L,QSA]

# Handles POST access to book_pings_lib 
RewriteCond %{THE_REQUEST} POST
RewriteRule ^api/book_pings/?$ api/book_pings/book_ping.php [L]

#TODO update which php script this calls
RewriteCond %{THE_REQUEST} GET
RewriteRule ^api/book_pings/?$ test.php [L]

#TODO update which php script this calls
RewriteCond %{THE_REQUEST} GET
RewriteRule ^api/book_pings/count/?$ test.php [L]

RewriteCond %{THE_REQUEST} GET
RewriteRule ^api/book_pings/([0-9]+)(?=.json) api/book_pings/get_by_id.php?book_ping_id=$1 [L,QSA]

#Catch-all error message when someone tries to use non-existing API
#Note that there are TWO ways to get here!
#If you don't use L, then we will get here.
#Also, if you do any substitution, then it will get here
# via a re-direct...
RewriteCond %{ENV:REDIRECT_STATUS} !=200
RewriteRule ^api/(.*) sorry-api.php?api_info=/api/$1 [NS,QSA]
